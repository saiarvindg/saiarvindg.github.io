---
title: "Does Airbnb Cause Rent Prices to Increase?"
author: "SaiArvind Ganganapalle"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

### Motivation

In [season 2 episode 6](https://www.imdb.com/title/tt4498796/?ref_=ttep_ep6) of Netflix's [_Unbreakable Kimmy Schmidt_](https://www.netflix.com/title/80025384), Kimmy Schmidt (the main character) and her roommate Titus Andromedon rent out their apartment on Airbnb. This action worries their landlord, Lillian Kaushtupper, as Lillian believes that Airbnbs only attract affluent hipsters who will gentrify her beloved lower class New York City neighborhood. While Lillian's immediate correlation of Airbnb to gentrification is an overreaction, it made me wonder if Airbnb can lead to an increase in rent prices of surrounding apartments. 

### Background

[Airbnb](https://www.airbnb.com/) is an online marketplace and hospitality service for people to lease or rent short-term lodging. Most regular apartment renting is done through leases which last over a long period of time, usually six months to one year. Airbnbs usually only last a few days to a couple of weeks as it is an alternative to hotels and traditional bed and breakfasts place. Because of the shorter length of stay, Airbnbs are more expensive per night than the per night equivalent of a month's rent for a long term apartment lease. So if Airbnbs start cropping up in below middle class neighborhoods and middle class people rent out those Airbnbs, could that influence landlord's to increase rent prices as the landlords see there are people willing to pay more to rent their property? 

### Question - come back to methodology

As indicated by the title, the main question we are trying to answer is does Airbnb cause rent prices in surrounding areas to increase. The way we will be 

### Data

In order to carry out this experiment, I need historical rent data for apartments (which I will call rent data) in New York City and historical data for Airbnb (which I will call Airbnb data) prices in New York City. The historical rent data will be from [Apartment List](https://www.apartmentlist.com/rentonomics/rental-price-data/) and historical Airbnb data will be from [Inside Airbnb](http://insideairbnb.com/get-the-data.html). 

## Steps

I) Data Curation
	i) Data Collection
	ii) Data Processing
II) Exploratory Data Analysis
III) Machine Learning
IV) Conclusions
V) Further Reading

## I. Data Curation

### i. Data Collection

#### Getting the Rent Data
The rent data from Apartment List is a single CSV file that can be downloaded from [here](https://www.apartmentlist.com/rentonomics/rental-price-data/?). Click on the `Select the Data Report to download` dropdown, select `City-Level Historic Data (2014-present)`, and click `DOWNLOAD FILE`. Save the path to the file in a variable. 

```{r get_rent_data, eval=TRUE}
rent_data_path <- "./Apartment-List-Rent-Data-City_2018-2.csv"
```


#### Getting the Airbnb Data
The Airbnb data is spread out over multiple CSV files where each zipped CSV file contains data for a single month of Airbnb listings. We will get each file, unzip it, rename it, and store it a folder. 

First, we will get the raw HTML of the Airbnb data page.
```{r airbnb_html, eval=TRUE}
airbnb_url <- "http://insideairbnb.com/get-the-data.html"
airbnb_html <- paste(readLines(airbnb_url), collapse = "\n")
```

Second, we need to extract all links to the zipped CSV files for New York City. We will be using the data file named `listings.csv` that contains summary information and metrics for listings in New York City. If we inspect a few of the `listings.csv` links (right click the link and click "Inspect"), we see the URL to the actual CSV file in the anchor tag's href attribute. All of New York City's CSV files' URLs are in the same format with the date changed. More specifically, the format looks like this: `http://data.insideairbnb.com/united-states/ny/new-york-city/{YYYY}-{MM}-{DD}/data/listings.csv.gz`. 

So now we can build a regex and extract all the links that match the URL format for the CSV files using `stringr`. The regex `\d{4}-\d{2}-\d{2}` matches date strings in the YYYY-MM-DD format.

```{r url_regex, eval=TRUE}
library(stringr)

# create the link regex
airbnb_link_regex <- "http://data\\.insideairbnb\\.com/united-states/ny/new-york-city/\\d{4}-\\d{2}-\\d{2}/visualisations/listings\\.csv"

# match all occurences of the regex in the raw HTML
matched_data_links <- str_match_all(airbnb_html, airbnb_link_regex)
# get the vector of matched links
airbnb_data_links <- matched_data_links[[1]][,1]

# Jan 2018 has duplicate links and Nov 2015 has two links from two days (Nov 1st and Nov 20th) in the month. 
# We will get rid of the duplicate Jan 2018 link and use the first Nov 2015 link to keep consistent with the other months
airbnb_data_links <- unique(airbnb_data_links) # removes duplicate links
airbnb_data_links <- airbnb_data_links[-28] # remove the Nov 20 link located at index 28

airbnb_data_links %>% head()

two_links <- c("http://data.insideairbnb.com/united-states/ny/new-york-city/2015-01-01/visualisations/listings.csv", "http://data.insideairbnb.com/united-states/ny/new-york-city/2016-04-03/visualisations/listings.csv")
```

Now that we have all the links to the zipped CSV files, we can download them into a directory. We will write a function that extracts the date from the link, parses the date using `lubridate`, uses the parsed date to create a new file, and downloads the CSV file into the newly created file.

```{r get_airbnb_date, eval=FALSE, message=FALSE, warning=FALSE}
# folder where all the unzipped CSV files will go
airbnb_data_dir <- "./airbnbdata"

library(lubridate)

# invisible() just suppresses output
# use the airbnb_data_link from above
invisible(sapply(airbnb_data_links, function(link) {
	extracted_date <- str_extract(link,"\\d{4}-\\d{2}-\\d{2}") # extract the date from the link
	parsed_date <- ymd(extracted_date) # parse date with lubridate
	
	# create the new file name with the format YYYY-MM
	tarfile_name <- paste(year(parsed_date),month(parsed_date,abbr = FALSE, label = FALSE),sep = "-")
	
	# create the new full file path along with the extension
	tarfile_path <- paste0(airbnb_data_dir,"/",tarfile_name,".csv")
	
	file.create(tarfile_path) # create the file
	download.file(link, tarfile_path) # download the file from the link into the file
}))

list.files(airbnb_data_dir) %>% head()
```

### ii. Data Processing

We eventually need a single data frame with entities as the months and the attributes as the rent price and Airbnb price.

#### Processing Rent Data
The single rent data CSV file contains the median rent price for different types of apartments for different U.S. cities. We will be using rent data from January 2015 to February 2018 for a 1 bedroom apartment in New York City. Even though there is rent information from January 2014, the Airbnb data only goes back until January 2015 so only the rent data from January 2015 will be used. Let's read the CSV into a data frame.

```{r read_rent_data, eval=TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)

rent_raw_data <- read.csv(rent_data_path)
rent_df <- rent_raw_data
```

Now that the CSV is in a data frame, let us make it tidy. First, we will drop all irrelevant information. This means dropping all cities except for New York, dropping the type of locatino, and dropping all bedroom sizes except for 1 bedroom. We can also drop `Location`, `Location_Type`, and `Bedroom_Size` Then let's rename the columns to only include the month and year written out using `rename_all` and `lubridate`.
```{r rent_data_first_cleaning, eval=TRUE}
nyc_rent_df <- rent_df %>% 
	filter(Location == "New York, NY") %>% # only keep New York City rows
	filter(Bedroom_Size == "1br") %>% # only keep data for 1 bedroom apartment
	# Location_Type,Bedroom_Size, and Location
	select(-Location, -Location_Type, -Bedroom_Size) %>%
	# renaming the dates
	rename_all(funs(
		str_replace_all(., 'Price_', '') %>% # remove the "Price_" so lubridate can parse the date
		lubridate::ymd(., truncated = 2) # parse the dates
	))

nyc_rent_df
```

Currently, there is only one entity in the rent data frame - the prices for New York City. However, we need each entity to be a month and the attribute (column) to be the rent price. So we will transform the data frame using the `gather` function which transposes the rows and columns.
```{r rent_data_second_cleaning, eval=TRUE}
nyc_rent_df <- nyc_rent_df %>% 
	mutate(Date = "MonthlyRentPrice") %>% # add a new column that will hold the new column names
	gather(Date, MonthlyRentPrice) # gather the data so that the columns become the rows

library(readr)
library(lubridate)

final_nyc_rent_df <- as_tibble(nyc_rent_df) %>%  # convert to a tibble
	mutate(Date = ymd(Date)) %>%  # ensure the Date column is a date
	mutate(NightlyRentPrice = MonthlyRentPrice / 30) %>% 
	select(-MonthlyRentPrice) # drop the monthly rent price as it is not needed anymore

final_nyc_rent_df
```
We now have our cleaned data frame for the rent data for each month of a 1 bedroom New York City apartment.

#### Processing Airbnb Data

For the Airbnb data, we have mutliple CSV files which all need to be merged into one data frame. So first we will clean each CSV file, then get the required information from each CSV, and finally merge the information from each CSV into one data frame.

We will create a function that loads each CSV into a data frame, and drops all irrelevant information. We only want entries where the `room_type` is a private room (equivalent to a 1 bedroom apartment). And we only want the nightly price (column named `price`). Then the median nightly price from each data frame's nightly prices will be calculated and used as that month's Airbnb price (remember each CSV file is a month of Airbnb listings). The median is being used as it is not influenced by outliers. Whereas the mean and mode would be subject to outliers and spread within the data. In addition, the Apartment List rent data uses the median from their data.
```{r airbnb_cleaning, eval=TRUE}
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)

airbnb_data_dir <- "./airbnbdata"

# create a new data frame to hold the nightly Airbnb price based on all the Airbnb data files
airbnb_df <- data.frame(Date=as.Date(character()),NightlyAirbnbPrice=double(), stringsAsFactors = FALSE)

airbnb_files <- list.files(airbnb_data_dir, full.names = TRUE)
for (file in airbnb_files) {
	df <- read.csv(file) # read the CSV file
	df <- df %>% 
		filter(room_type == "Private room") %>% # keep only the Private rooms
		select(price) # drop all other columsn other than the nightly price
	
	# get rid of the dollar sign so the column can parsed as numeric
	df$price <- as.numeric(df$price)
	median_price <- median(df$price) # calculate the median price
	
	# get and parse the date from the file name
	extracted_date <- str_extract(file,"\\d{4}-\\d+")
	parsed_date <- ymd(extracted_date, truncated = 2)
	
	# now we have the median price, so add the date and median price to the Airbnb data frame
	airbnb_df <- rbind(airbnb_df, data.frame(Date=parsed_date, NightlyAirbnbPrice=median_price))
}
final_nyc_airbnb_df <- as_tibble(airbnb_df)
final_nyc_airbnb_df
```

Our last step is make sure both data frames have the same time periods and are in one data frame. If we take a look at the rent data time period, it goes from January 2014 to February 2018. The Airbnb data time period goes from January 2015 to March 2018 with some gaps. Let's now trim and remove from both data frames so they match in terms of time periods.

We will perform an `inner_join` on the `Date` to only keep dates appearing in both data frames.
```{r df_merging, eval=TRUE}
library(tidyr)

final_df <- final_nyc_rent_df %>% 
	inner_join(final_nyc_airbnb_df, by="Date")

final_df
```

Now we have one data frame with nightly prices for an apartment and an Airbnb for New York City.

## II. Exploratory Data Analysis

Let's plot the rent prices and Airbnb prices data separately to see how each behaves over three years.

```{r plot_rent, eval=TRUE}

```

## III. Machine Learning

## IV. Conclusion

## V. Further Reading

### Can we predict monthly rent prices from Airbnb (or vice versa)?